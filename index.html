<!DOCTYPE html>
<!-- 
  TODOs
  - styling the answer button

  - export as module?
 -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      /* Reset and tweak default appearance */
      progress[value] {
        position: absolute;
        top: 0;
        -webkit-appearance: none;
        appearance: none;
        background-color: transparent;
        height: 4px;
        translate: 0 -4px;
        border: 0;
        vertical-align: 0;
      }
      ::-webkit-progress-bar {
        background-color: transparent;
      }
      ::-moz-progress-bar {
        background-color: orange;
      }
      ::-webkit-progress-value {
        background-color: orange;
      }

      body {
        margin: 0;
        background-color: black;
        display: grid;
        place-items: center;
        min-height: 100vh;
      }

      main {
        position: relative;
      }

      main > * {
        position: absolute;
        transform: translate(-50%, -50%);
      }

      #asker {
        position: fixed;
        bottom: 0;
        background-color: white;
        width: 100%;
      }
      #asker > progress {
        width: 100%;
      }
      #asker > #choices {
        display: flex;
        justify-content: space-evenly;

        margin: 1rem;
      }

      .hidden {
        opacity: 0; /*faster than display none*/
      }

      .slidable {
        transition: translate 0.2s ease-out;
      }
      .slid-down {
        translate: 0 100%;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- vids go here -->
    </main>
    <div id="asker" class="slidable slid-down">
      <progress id="timeout" max="100" value="0"></progress>
      <div id="choices">
        <!-- choices go here -->
      </div>
    </div>
    <template id="question-template">
      <div>
        <button class="answer-btn" data-answer="">C</button>
        <label for=""></label>
      </div>
    </template>
    <script>
      const vids = Array.from(document.querySelectorAll("main video"));
      const btns = Array.from(document.querySelectorAll(".answer-btn"));
      let currentVidSrc = null;
      let progressEndedCallbacks = {};
      let progressTicking = false;

      console.log(btns);
      console.log(progressEndedCallbacks);

      // setProgressColor("#F00");
      // setInterval(() => {
      //   showAsker();
      //   setTimeout(() => hideAsker(), 1000);
      // }, 2000);

      // addProgressEndedCallback(() => console.log("hola"));
      // addProgressEndedCallback(() => console.log("hello"));
      // addProgressEndedCallback(() => console.log("sup ma boi"));

      window.addEventListener("keydown", (event) => {
        const answers = btns.map((btn) => btn.dataset["answer"]);
        const letterPressed = event.key.toLowerCase();

        if (answers.includes(letterPressed)) {
          answer(letterPressed);
        }
      });

      function registerVid(vidSrc) {
        let newVid = document.createElement("video");
        newVid.src = vidSrc;
        newVid.classList.add("hidden");
        document.querySelector("main").appendChild(newVid);

        newVid.addEventListener("ended", () => {
          if (typeof onVideoEnded === "function") {
            onVideoEnded(vidSrc);
          }
        });

        if (!currentVidSrc) {
          currentVidSrc = vidSrc;
        }
      }

      function answer(answerKey) {
        // TODO : style the buttons for feedback

        if (typeof onAnswer === "function") {
          onAnswer(answerKey);
        }
      }

      function playVid(vidSrc) {
        const currentVid = document.querySelector(
          `video[src="${currentVidSrc}"]`
        );
        const newVid = document.querySelector(`video[src="${vidSrc}"]`);
        // FIXME : check that both aren't undefined

        currentVid.classList.add("hidden");
        newVid.classList.remove("hidden");

        currentVid.pause();
        currentVid.currentTime = 0;
        newVid.play();
        currentVidSrc = vidSrc;
      }

      function getProgressEl() {
        return document.querySelector("progress");
      }

      function getAsker() {
        return document.querySelector("#asker");
      }

      function startProgress(totalTime) {
        let startTime;
        const progressEl = getProgressEl();
        progressTicking = true;

        requestAnimationFrame(progress);

        function progress(timeStamp) {
          if (startTime === undefined) {
            startTime = timeStamp;
          }
          const elapsed = timeStamp - startTime;

          if (progressTicking && elapsed < totalTime) {
            progressEl.value = (elapsed / totalTime) * 100;
            requestAnimationFrame(progress);
          } else if (progressTicking) {
            progressTicking = false;
            progressEl.value = 0;
            execProgressEndedCallbacks();
            if (typeof onProgressEnded === "function") {
              onProgressEnded();
            }
          }
        }
      }

      function cancelProgress() {
        const progressEl = getProgressEl();
        progressTicking = false;
        progressEl.value = 0;
      }

      function setProgressColor(color) {
        const progressEl = getProgressEl();

        // TODO : make a separate stylesheet at runtime with a title, only for this
        // instead of doing a shitty nested loop running over all the styles
        for (let stylesheet of document.styleSheets) {
          for (let rule of stylesheet.cssRules) {
            if (
              rule.selectorText.includes("::-moz-progress-bar") ||
              rule.selectorText.includes("::-webkit-progress-value")
            ) {
              rule.style["background-color"] = color;
            }
          }
        }
      }

      // private
      function execProgressEndedCallbacks() {
        Object.values(progressEndedCallbacks).forEach((cb) => {
          cb();
        });
      }

      // optionnal
      function addProgressEndedCallback(callback) {
        let newId;

        do {
          newId = crypto.randomUUID();
        } while (progressEndedCallbacks.newId);

        progressEndedCallbacks[newId] = callback;
        return newId;
      }

      // optionnal
      function removeProgressEndedCallback(callbackId) {
        delete progressEndedCallbacks[callbackId];
      }

      function showAsker() {
        const asker = getAsker();
        asker.classList.remove("slid-down");
      }

      function hideAsker() {
        const asker = getAsker();
        asker.classList.add("slid-down");
      }

      function addQuestion(answerKey, answerLabel) {
        if (typeof answerKey !== "string" || !answerKey.match(/^[a-zA-Z]$/i)) {
          throw (
            "when adding a question you must provide a single letter as the answer key\nyou provided: " +
            answerKey
          );
        }

        const templateQuestion = document.querySelector("#question-template");
        const newQuestion =
          templateQuestion.content.firstElementChild.cloneNode(true);
        newQuestion.querySelector("label").innerText = answerLabel;

        const btn = newQuestion.querySelector("button");
        btn.dataset["answer"] = answerKey;
        btn.innerText = answerKey.toUpperCase();
        btn.addEventListener("click", () => answer(btn.dataset["answer"]));

        document.querySelector("#choices").appendChild(newQuestion);
      }

      function removeQuestion(answerKey) {
        const container = document.querySelector("#choices");
        Array.from(container.children).forEach((child) => {
          if (child.querySelector(`button[data-answer=${answerKey}]`)) {
            child.remove();
          }
        });
      }

      function removeQuestionWithLabel(answerLabel) {
        const container = document.querySelector("#choices");
        Array.from(container.children).forEach((child) => {
          if (child.querySelector("label").innerText.includes(answerLabel)) {
            child.remove();
          }
        });
      }

      function clearQuestions() {
        const container = document.querySelector("#choices");
        Array.from(container.children).forEach((child) => child.remove());
      }
    </script>
    <script src="userScript.js"></script>
  </body>
</html>
